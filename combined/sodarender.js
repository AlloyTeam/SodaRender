/**
 * SodaRender
 * light Tml render engine
 * copyright @ Tencent AlloyTeam
 * License under MIT License
 * @author dorsywang
 * @email 314416946@qq.com
 * @blog http://www.dorsywang.com
 * @TeamBlog http://www.alloyteam.com
 */
(function(){var e=/\{\{([^\}]*)\}\}/g,t=function(e,n){var r=n.indexOf(".");if(r>-1){var i=n.substr(0,r);return n=n.substr(r+1),e[i]?t(e[i],n):""}return e[n]||""},n=function(e){},r=/[a-zA-Z_\$]+[\w\$]*/g,i=/"[^"]*"/g,s=/\d+|\d*\.\d+/g,o=/[a-zA-Z_\$]+[\w\$]*(?:[a-zA-Z_\$]+[\w\$]*|\.|\s)*/g,u=function(e){var e=e.split("|"),n=e[0]||"",r=e.slice(1);n=n.replace(o,function(e){return"getValue(scope,'"+e.trim()+"')"});var i=function(){var e=r.shift();if(!e)return;var e=e.split(":"),t=e.slice(1)||[],s=e[0]||"";l[s]&&(t.unshift(n),t=t.join(","),n="sodaFilterMap['"+s+"']("+t+")"),i()};i(),console.log(n);var s=(new Function("getValue","sodaFilterMap","return function sodaExp(scope){ return "+n+"}"))(t,l);return s},a=function(t,n){[].map.call([].slice.call(t.childNodes,[]),function(t){t.nodeType===3&&(t.nodeValue=t.nodeValue.replace(e,function(e,t){return u(t)(n)})),t.attributes&&(/in/.test(t.getAttribute("soda-repeat")||"")?f["soda-repeat"].link(n,t,t.attributes):[].map.call(t.attributes,function(e){if(/^soda-/.test(e.name)&&f[e.name]){var r=f[e.name];r.link(n,t,t.attributes)}}))})},f={},l={},c=function(e,t){f["soda-"+e]=t()},h=function(e,t){l[e]=t};h("date",function(e,t){return t}),c("repeat",function(){return{compile:function(e,t,n){},link:function(e,n,r){var i=n.getAttribute("soda-repeat"),s,o;if(!/in/.test(i))return;i=i.split("in"),s=i[0].trim(),o=i[1].trim();var u=t(e,o),l=n;for(var c=0;c<u.length;c++){var h=n.cloneNode(),p={$index:c};p[s]=u[c],p.__proto__=e,h.innerHTML=n.innerHTML,[].map.call(h.attributes,function(e){if(h.getAttribute("removed")==="removed")return;if(/^soda-/.test(e.name)&&e.name.trim()!=="soda-repeat"&&f[e.name]){var t=f[e.name];t.link(p,h,h.attributes)}}),h.getAttribute("removed")!=="removed"&&(a(h,p),n.parentNode.insertBefore(h,l.nextSibling),l=h)}n.parentNode.removeChild(n)}}}),c("if",function(){return{link:function(e,t,n){var r=t.getAttribute("soda-if"),i=u(r);console.log(i),i(e)||t.setAttribute("removed","removed")}}});var p=function(e,t){var n=document.createElement("div");n.innerHTML=e,a(n,t),console.log(n),console.log(n.innerHTML),document.body.appendChild(n);var r=document.createDocumentFragment();return[].map.call(n.childNodes,function(e){r.appendChild(e)}),r.innerHTML=n.innerHTML,r};window.sodaRender=p,window.sodaFilter=h})()
